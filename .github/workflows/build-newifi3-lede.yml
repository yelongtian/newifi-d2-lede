# 工作流名称
name: Build Newifi 3 LEDE Firmware (64MB W25Q512JVFIQ)

# 触发条件：手动触发（推荐）+ 仅修改该配置文件时自动触发
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-newifi3-lede.yml'

# 运行环境与编译任务
jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write

    steps:
      # 步骤1：检出源码（含子模块）
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      # 步骤2：安装编译依赖（完整版）
      - name: Install Build Dependencies
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget libelf-dev libncursesw5-dev python3 python3-pip xz-utils swig \
            libc6-dev-i386 liblzma-dev libzstd-dev
          sudo apt autoremove -y && sudo apt clean -y
          sudo rm -rf /var/lib/apt/lists/*

      # 步骤3：配置闪存分区（适配64MB闪存）
      - name: Configure Flash Partitions
        run: |
          echo "=== 开始配置64MB闪存分区 ==="

          # 修改设备树文件以支持64MB闪存
          sed -i 's/reg = <0x50000 0x1fb0000>;/reg = <0x50000 0x3fb0000>;/' target/linux/ramips/dts/mt7621_d-team_newifi-d2.dts
          echo "✅ 已修改设备树文件支持64MB闪存"

          # 修改固件打包大小（64512k = 63MB，匹配64MB闪存分区）
          sed -i '/define Device\/d-team_newifi-d2/,/endef/ s/IMAGE_SIZE := .*/IMAGE_SIZE := 64512k/' target/linux/ramips/image/mt7621.mk
          echo "✅ 已调整固件最大大小为64512k"
          echo "✅ W25Q512JVFIQ 闪存支持已通过补丁文件添加"

      # 步骤4：配置编译参数（指定新路由3机型）
      - name: Configure Build Options
        run: |
          # 加载默认配置
          make defconfig
          # 强制指定编译目标
          echo -e "\nCONFIG_TARGET_ramips=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          echo "CONFIG_TARGET_ramips_mt7621_DEVICE_d-team_newifi-d2=y" >> .config
          # 可选：启用IPv6、移除不必要组件
          echo "CONFIG_IPV6=y" >> .config
          echo "CONFIG_DROP_BINARY_FILES=y" >> .config
          # 重新生成配置
          make defconfig
          echo "✅ 编译配置完成"

      # 步骤5：下载依赖包（避免编译时网络问题）
      - name: Download Dependencies
        run: |
          make -j2 download V=s
          # 删除空文件/无效包
          find dl -size -1024c -exec rm -f {} \;
          echo "✅ 依赖包下载完成"

      # 步骤6：编译固件（2线程适配GitHub Actions资源）
      - name: Build Firmware
        run: |
          make -j2 V=s || make -j1 V=s  # 单线程降级容错
          # 压缩日志用于排错
          tar -czf build-logs.tar.gz logs/ || echo "日志压缩失败，忽略"
          echo "✅ 固件编译完成"

      # 步骤7：上传编译产物（固件+日志）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: newifi3-64mb-firmware
          path: |
            bin/targets/ramips/mt7621/*.bin
            build-logs.tar.gz
          retention-days: 30  # 产物保留30天
          if-no-files-found: warn  # 无文件时仅警告，不终止
