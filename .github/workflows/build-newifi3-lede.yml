# 工作流名称
name: Build Newifi 3 LEDE Firmware (64MB Flash)

# 触发条件：手动触发 + push到main分支时触发
on:
  workflow_dispatch:  # 手动触发（推荐）
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-newifi3-lede.yml'  # 仅修改该配置文件时触发push编译

# 运行环境
jobs:
  build:
    runs-on: ubuntu-22.04  # 使用Ubuntu 22.04（兼容LEDE编译）
    steps:
      # 步骤1：检出源码
      - name: Checkout LEDE Source
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # 检出你Fork的仓库
          submodules: 'recursive'  # 拉取子模块（LEDE依赖）
          fetch-depth: 1

      # 步骤2：安装编译依赖
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev libncursesw5-dev python3 python3-pip xz-utils swig libc6-dev-i386
          sudo apt autoremove -y && sudo apt clean -y

      # 步骤3：应用W25Q512JVFIQ闪存配置（若你已提交修改，可注释此步骤）
      - name: Add W25Q512JVFIQ Config
        run: |
          # 1. 修改winbond.c添加闪存ID
          sed -i '/{ "w25q256",  INFO(0xef1900, 0, 64 * 1024, 512, SECT_4K) },/a \    { "w25q512jv", INFO(0xef1a00, 0, 64 * 1024, 1024, SECT_4K) }, // W25Q512JVFIQ (64MB)' drivers/mtd/spi-nor/winbond.c
          
          # 2. 修改设备树DTS文件
          cat > target/linux/ramips/dts/mt7621_newifi-d2.dts << 'EOF'
          #include "mt7621.dtsi"
          #include <dt-bindings/gpio/gpio.h>
          #include <dt-bindings/input/input.h>

          / {
              compatible = "newifi,d2", "mediatek,mt7621-soc";
              model = "Newifi D2 (Newifi 3)";

              aliases {
                  led-boot = &led_status;
                  led-failsafe = &led_status;
                  led-running = &led_status;
                  led-upgrade = &led_status;
              };

              leds {
                  compatible = "gpio-leds";

                  led_status: status {
                      label = "blue:status";
                      gpios = <&gpio0 13 GPIO_ACTIVE_LOW>;
                  };
              };

              keys {
                  compatible = "gpio-keys";

                  reset {
                      label = "reset";
                      gpios = <&gpio0 18 GPIO_ACTIVE_LOW>;
                      linux,code = <KEY_RESTART>;
                  };
              };
          };

          &spi0 {
              status = "okay";

              flash@0 {
                  compatible = "winbond,w25q512jv", "jedec,spi-nor";
                  reg = <0>;
                  spi-max-frequency = <80000000>;

                  partitions {
                      compatible = "fixed-partitions";
                      #address-cells = <1>;
                      #size-cells = <1>;

                      partition@0 {
                          label = "u-boot";
                          reg = <0x000000 0x030000>;
                          read-only;
                      };

                      partition@30000 {
                          label = "u-boot-env";
                          reg = <0x030000 0x010000>;
                      };

                      partition@40000 {
                          label = "factory";
                          reg = <0x040000 0x010000>;
                          read-only;
                      };

                      partition@50000 {
                          label = "firmware";
                          reg = <0x050000 0x3fb0000>;
                      };
                  };
              };
          };

          &pcie {
              status = "okay";
          };

          &pcie0 {
              mt76@0,0 {
                  reg = <0x0000 0 0 0 0>;
                  mediatek,mtd-eeprom = <&factory 0x8000>;
                  ieee80211-freq-limit = <5000000 6000000>;
              };
          };

          &pcie1 {
              mt76@0,0 {
                  reg = <0x0000 0 0 0 0>;
                  mediatek,mtd-eeprom = <&factory 0x0000>;
                  ieee80211-freq-limit = <2400000 2500000>;
              };
          };

          &gmac0 {
              mtd-mac-address = <&factory 0xe000>;
          };

          &switch0 {
              ports {
                  port@0 {
                      status = "okay";
                      label = "lan1";
                  };

                  port@1 {
                      status = "okay";
                      label = "lan2";
                  };

                  port@2 {
                      status = "okay";
                      label = "lan3";
                  };

                  port@3 {
                      status = "okay";
                      label = "lan4";
                  };

                  port@4 {
                      status = "okay";
                      label = "wan";
                      mtd-mac-address = <&factory 0xe006>;
                  };
              };
          };

          &state_default {
              gpio {
                  groups = "i2c", "uart2", "uart3", "jtag", "wdt";
                  function = "gpio";
              };
          };
          EOF
          
          # 3. 修改mt7621.mk调整固件大小
          sed -i 's/IMAGE_SIZE := .*/IMAGE_SIZE := 64512k/' target/linux/ramips/image/mt7621.mk

      # 步骤4：配置编译选项（选择Newifi D2机型）
      - name: Configure Build
        run: |
          # 加载默认配置
          make defconfig
          # 手动指定目标机型（确保编译Newifi D2）
          echo -e "\nCONFIG_TARGET_ramips=y\nCONFIG_TARGET_ramips_mt7621=y\nCONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" >> .config
          # 启用IPv6（可选）
          echo "CONFIG_IPV6=y" >> .config
          # 保存配置
          make defconfig

      # 步骤5：下载编译依赖包
      - name: Download Dependencies
        run: |
          make -j$(nproc) download V=s
          find dl -size -1024c -exec rm -f {} \;  # 删除空文件

      # 步骤6：开始编译固件
      - name: Build Firmware
        run: |
          make -j$(nproc) V=s  # -j后为CPU核心数，Actions默认2核，可改为-j2避免过载
          # 压缩编译日志（便于排查错误）
          tar -czf build-logs.tar.gz logs/

      # 步骤7：上传编译产物（固件+日志）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: newifi3-lede-firmware-64mb
          path: |
            bin/targets/ramips/mt7621/*.bin  # 所有固件文件
            build-logs.tar.gz                # 编译日志
          retention-days: 30  # 产物保留30天
